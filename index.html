<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>เครื่องคำนวณการให้ยา Warfarin</title>
  <style>
    body {
      font-family: 'Kanit', sans-serif, sans-serif;
      margin: 20px; background: #E3F2FD;
      color: #263238;
    }
    .container {
      max-width: 720px; margin: auto;
      background: #fff; padding: 20px;
      border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }
    label {
      display: block; margin-top: 12px; font-weight: 600;
    }
    input[type=number], select {
      width: 100%; padding: 10px; font-size: 16px;
      border-radius: 8px; border: 1px solid #ccc;
      margin-top: 6px;
    }
    button {
      margin-top: 20px; padding: 12px 20px;
      font-size: 16px; font-weight: 600;
      border: none; border-radius: 10px;
      background-color: #4CAF50; color: white;
      cursor: pointer;
    }
    button:disabled {
      background-color: #9E9E9E;
      cursor: not-allowed;
    }
    table {
      width: 100%; border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd; padding: 8px;
      text-align: center;
    }
    th {
      background-color: #4CAF50;
      color: white;
    }
    .pill {
      display: inline-block;
      width: 20px; height: 20px;
      margin: 0 2px;
      border-radius: 50%;
      vertical-align: middle;
    }
    .pill-3mg { background: #4CAF50; }
    .pill-2mg { background: #2196F3; }
    .info-box {
      background: #FFF8E1;
      border: 1px solid #FFEB3B;
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
      white-space: pre-line;
    }
    footer {
      margin-top: 30px; font-size: 14px; color: #607D8B;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>เครื่องคำนวณการให้ยา Warfarin</h1>

    <label for="inr">INR ปัจจุบัน</label>
    <input type="number" step="0.01" id="inr" value="2.5" min="0" required>

    <label for="weeklyDose">ขนาดยา Warfarin ต่อสัปดาห์ (mg)</label>
    <input type="number" step="0.1" id="weeklyDose" value="35" min="0" required>

    <label for="bleeding">ภาวะเลือดออก</label>
    <select id="bleeding">
      <option value="no" selected>ไม่มี</option>
      <option value="major">เลือดออกรุนแรง</option>
    </select>

    <label>ชนิดเม็ดยาที่ใช้</label>
    <select id="pillChoice">
      <option value="3">ใช้เม็ด 3 mg เท่านั้น</option>
      <option value="2">ใช้เม็ด 2 mg เท่านั้น</option>
      <option value="both" selected>ใช้ทั้ง 2 mg และ 3 mg</option>
    </select>

    <button id="calculateBtn">คำนวณขนาดยาใหม่</button>

    <div id="output"></div>

    <button id="downloadBtn" style="display:none;">ดาวน์โหลดผลลัพธ์</button>

    <footer>
      เครื่องมือนี้เป็นเครื่องมือช่วยคำนวณเท่านั้น ไม่ใช่คำสั่งการรักษา แพทย์/เภสัชกรเป็นผู้ตัดสินใจขั้นสุดท้าย
    </footer>
  </div>

<script>
const dayNames = ['จันทร์', 'อังคาร', 'พุธ', 'พฤหัส', 'ศุกร์', 'เสาร์', 'อาทิตย์'];

document.getElementById('calculateBtn').addEventListener('click', calculateDose);
document.getElementById('downloadBtn').addEventListener('click', downloadResult);

let lastResultText = '';

function calculateDose() {
  const inr = parseFloat(document.getElementById('inr').value);
  const bleeding = document.getElementById('bleeding').value;
  const weeklyDose = parseFloat(document.getElementById('weeklyDose').value);
  const pillChoice = document.getElementById('pillChoice').value;

  const output = document.getElementById('output');
  output.innerHTML = '';
  lastResultText = '';

  if (isNaN(inr) || isNaN(weeklyDose) || weeklyDose <= 0) {
    output.innerHTML = `<div class="info-box">กรุณากรอกค่า INR และขนาดยาเดิมให้ถูกต้อง</div>`;
    document.getElementById('downloadBtn').style.display = 'none';
    return;
  }

  // คำนวณปรับขนาดยาตาม INR และ bleeding
  const adj = getAdjustment(inr, bleeding);
  let newWeeklyDose = adj.override ? 0 : weeklyDose * (1 + adj.percent);

  let adviceText = adj.text;

  if (adj.override) {
    newWeeklyDose = 0;
  }

  output.innerHTML += `<div class="info-box"><strong>คำแนะนำ:</strong> ${adviceText}</div>`;

  if (adj.override) {
    document.getElementById('downloadBtn').style.display = 'none';
    return;
  }

  output.innerHTML += `<p><strong>ขนาดยาใหม่:</strong> ${newWeeklyDose.toFixed(2)} mg/สัปดาห์</p>`;
  output.innerHTML += `<p><strong>เฉลี่ย:</strong> ${(newWeeklyDose / 7).toFixed(2)} mg/วัน</p>`;

  let dailyPlan;
  if (pillChoice === '3') {
    dailyPlan = distributeDoseSinglePill(newWeeklyDose, 3);
  } else if (pillChoice === '2') {
    dailyPlan = distributeDoseSinglePill(newWeeklyDose, 2);
  } else {
    dailyPlan = distributeDoseBothPills(newWeeklyDose);
  }

  output.innerHTML += buildTable(dailyPlan);

  // เก็บข้อความผลลัพธ์ไว้สำหรับดาวน์โหลด
  lastResultText = buildTextOutput(inr, bleeding, weeklyDose, newWeeklyDose, adviceText, dailyPlan);

  document.getElementById('downloadBtn').style.display = 'inline-block';
}

function getAdjustment(inr, bleeding) {
  if (bleeding === 'major') {
    return { percent: 0, text: "ให้ Vitamin K₁ 10 mg IV + FFP และ repeat ทุก 12 ชม.", override: true };
  }
  if (inr >= 9.0) return { percent: 0, text: "ให้ Vitamin K₁ 5–10 mg oral", override: true };
  if (inr > 5.0) return { percent: 0, text: "หยุดยา 1–2 วัน + Vitamin K₁ 1 mg oral", override: true };
  if (inr > 4.0) return { percent: -0.10, text: "หยุดยา 1 วัน แล้วลดขนาดยา 10%" };
  if (inr > 3.0) return { percent: -0.075, text: "ลดขนาดยา 5–10%" };
  if (inr >= 2.0) return { percent: 0, text: "ให้ขนาดยาเท่าเดิม" };
  if (inr >= 1.5) return { percent: 0.075, text: "เพิ่มขนาดยา 5–10%" };
  return { percent: 0.15, text: "เพิ่มขนาดยา 10–20%" };
}

// แจกแจงเม็ดเดียว (3 mg หรือ 2 mg เท่านั้น)
function distributeDoseSinglePill(total, mg) {
  const dailyDose = total / 7;
  const perDayPillCount = dailyDose / mg;

  // ปัดครึ่งเม็ด (0.5) เช่น 1.5 เม็ด = 1 เม็ดเต็ม + ครึ่งเม็ด
  function roundHalf(num) {
    return Math.round(num * 2) / 2;
  }

  const results = [];
  for (let i = 0; i < 7; i++) {
    const pillCount = roundHalf(perDayPillCount);
    const dose = pillCount * mg;
    const pills = [];
    if (pillCount >= 1) {
      const fullPills = Math.floor(pillCount);
      for (let j = 0; j < fullPills; j++) pills.push(mg);
    }
    if (pillCount % 1 !== 0) {
      pills.push(mg / 2);
    }
    results.push({ totalDose: dose, pills });
  }
  return results;
}

// แจกแจงเม็ดยาทั้ง 2 mg และ 3 mg
function distributeDoseBothPills(total) {
  let maxHalf3 = Math.floor(total / 1.5);
  let bestCombo = null;
  let bestDiff = Infinity;

  for (let h3 = maxHalf3; h3 >= 0; h3--) {
    let rem = total - h3 * 1.5;
    let h2 = Math.round(rem / 1.0);
    if (h2 < 0) h2 = 0;

    let totalDose = h3 * 1.5 + h2 * 1.0;
    let diff = Math.abs(total - totalDose);

    if (diff < bestDiff) {
      bestDiff = diff;
      bestCombo = { h3, h2, totalDose };
      if (diff === 0) break;
    }
  }

  const results = [];
  const perDayH3 = Math.floor(bestCombo.h3 / 7);
  const remH3 = bestCombo.h3 % 7;
  const perDayH2 = Math.floor(bestCombo.h2 / 7);
  const remH2 = bestCombo.h2 % 7;

  for (let i = 0; i < 7; i++) {
    let dayH3 = perDayH3 + (i < remH3 ? 1 : 0);
    let dayH2 = perDayH2 + (i < remH2 ? 1 : 0);

    const pills = [];
    for (let j = 0; j < dayH3; j++) pills.push(1.5); // ครึ่งเม็ด 3 mg
    for (let j = 0; j < dayH2; j++) pills.push(1);   // ครึ่งเม็ด 2 mg

    const totalDose = dayH3 * 1.5 + dayH2 * 1.0;
    results.push({ totalDose, pills });
  }

  return results;
}

function buildTable(dailyPlan) {
  let html = `<table>
    <thead>
      <tr>
        <th>วัน</th>
        <th>ขนาดยา (mg)</th>
        <th>จำนวนเม็ด</th>
        <th>รูปเม็ด</th>
      </tr>
    </thead><tbody>`;

  for (let i = 0; i < 7; i++) {
    const day = dayNames[i];
    const d = dailyPlan[i];

    // แสดงจำนวนเม็ดแบบอ่านง่าย
    let pillDesc = d.pills.map(p => {
      if (p === 1.5) return "3 mg (ครึ่งเม็ด)";
      else if (p === 1) return "2 mg (ครึ่งเม็ด)";
      else if (p === 3) return "3 mg";
      else if (p === 2) return "2 mg";
      else return p + " mg";
    }).join(", ");

    // แสดงรูปเม็ดสีเขียว (3 mg) และ น้ำเงิน (2 mg)
    let pillIcons = d.pills.map(p => {
      if (p === 1.5 || p === 3) return '<span class="pill pill-3mg" title="3 mg"></span>';
      else if (p === 1 || p === 2) return '<span class="pill pill-2mg" title="2 mg"></span>';
      else return '';
    }).join("");

    html += `<tr>
      <td>${day}</td>
      <td>${d.totalDose.toFixed(1)}</td>
      <td>${pillDesc}</td>
      <td>${pillIcons}</td>
    </tr>`;
  }

  html += `</tbody></table>`;
  return html;
}

function buildTextOutput(inr, bleeding, oldDose, newDose, advice, dailyPlan) {
  let text = `เครื่องคำนวณ Warfarin\n\n`;
  text += `INR ปัจจุบัน: ${inr}\n`;
  text += `ภาวะเลือดออก: ${bleeding === 'major' ? 'เลือดออกรุนแรง' : 'ไม่มี'}\n`;
  text += `ขนาดยาเดิมต่อสัปดาห์: ${oldDose} mg\n`;
  text += `คำแนะนำ: ${advice}\n`;
  text += `ขนาดยาใหม่: ${newDose.toFixed(2)} mg/สัปดาห์\n\n`;
  text += `แผนการให้ยา 7 วัน:\n`;

  for (let i = 0; i < 7; i++) {
    const day = dayNames[i];
    const d = dailyPlan[i];
    let pillDesc = d.pills.map(p => {
      if (p === 1.5) return "3 mg (ครึ่งเม็ด)";
      else if (p === 1) return "2 mg (ครึ่งเม็ด)";
      else if (p === 3) return "3 mg";
      else if (p === 2) return "2 mg";
      else return p + " mg";
    }).join(", ");

    text += `${day}: ${d.totalDose.toFixed(1)} mg, เม็ด: ${pillDesc}\n`;
  }

  return text;
}

function downloadResult() {
  if (!lastResultText) return;

  const blob = new Blob([lastResultText], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'warfarin_plan.txt';
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>

